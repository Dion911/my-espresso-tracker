<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Espresso Tracker</title>

  <!-- Optional (keep if you already have these files). Safe to remove. -->
  <link rel="icon" type="image/png" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#B4833D">

  <style>
    :root{
      /* Palette */
      --bg:#F7F1E1;        /* Old lace */
      --panel:#E3D8C1;     /* Bone */
      --text:#66371B;      /* Kobicha */
      --muted:rgba(102,55,27,.65);
      --accent:#B4833D;    /* Dark goldenrod */
      --danger:#c62f2f;

      /* Effects */
      --line:rgba(102,55,27,.28);
      --hover:rgba(180,131,61,.14);
      --shadow:0 10px 18px rgba(102,55,27,.14);

      /* Shape */
      --radius:18px;
      --radius-lg:26px;
      --radius-sm:14px;

      /* Typography (keep system font like your current UI) */
      --sans:-apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,system-ui,Arial;
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--sans);
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 14px 14px 90px;
    }

    .header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(247,241,225,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .headerInner{
      max-width: 860px;
      margin: 0 auto;
      padding: 12px 14px 10px;
    }
    .headerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .brand img{
      width: 28px;
      height: 28px;
      border-radius: 10px;
      border: 2px solid var(--line);
      background:#fff;
      box-shadow: 0 6px 10px rgba(102,55,27,.10);
      object-fit: cover;
      flex: 0 0 auto;
    }
    .brandTitle{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }
    .brandTitle .h1{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
      line-height: 1.1;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandTitle .sub{
      font-size: 13px;
      color: var(--muted);
      margin:0;
    }

    .topActions{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .btn{
      border-radius: 999px;
      border: 2px solid var(--line);
      background:#fff;
      color: var(--text);
      padding: 10px 12px;
      font-weight: 750;
      font-size: 14px;
      box-shadow: 0 6px 10px rgba(102,55,27,.10);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px); }

    .primary{
      background: var(--accent);
      color:#fff;
      border-color: rgba(102,55,27,.40);
      box-shadow: var(--shadow);
      padding: 11px 14px;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .card{
      background:#fff;
      border-radius: var(--radius-lg);
      border: 2px solid var(--line);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .sectionTitle{
      font-size: 12.5px;
      color: var(--muted);
      letter-spacing: .12em;
      text-transform: uppercase;
      margin: 10px 2px 8px;
      font-weight: 800;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .fileRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    input[type="file"]{
      border: 2px solid var(--line);
      border-radius: 999px;
      padding: 8px 10px;
      background: #fff;
      max-width: 100%;
    }

    select, input[type="text"], input[type="number"], textarea{
      width: 100%;
      border: 2px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      background: #fff;
      color: var(--text);
      font-family: var(--sans);
      font-size: 15px;
      outline: none;
    }
    textarea{ min-height: 84px; resize: vertical; }

    .stats{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    @media (min-width: 760px){
      .stats{ grid-template-columns: repeat(4, 1fr); }
    }
    .stat{
      background: var(--panel);
      border-radius: var(--radius);
      border: 2px solid var(--line);
      padding: 12px;
      box-shadow: 0 8px 14px rgba(102,55,27,.12);
    }
    .stat .k{ font-size: 12.5px; color: var(--muted); font-weight: 800; }
    .stat .v{ font-size: 22px; font-weight: 900; margin-top: 6px; }

    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .seg button{
      border-radius: 999px;
      border: 2px solid var(--line);
      background:#fff;
      color: var(--text);
      padding: 9px 12px;
      font-weight: 800;
      cursor:pointer;
      box-shadow: 0 6px 10px rgba(102,55,27,.10);
    }
    .seg button.active{
      background: var(--accent);
      color:#fff;
      border-color: rgba(102,55,27,.40);
      box-shadow: var(--shadow);
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .shotItem{
      background:#fff;
      border-radius: var(--radius-lg);
      border: 2px solid var(--line);
      box-shadow: 0 10px 18px rgba(102,55,27,.12);
      padding: 12px 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
    }
    .shotMain{
      min-width: 0;
      flex: 1;
    }
    .shotTop{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 2px solid var(--line);
      background: var(--panel);
      font-size: 13px;
      font-weight: 850;
      white-space:nowrap;
    }
    .pill.result{
      background:#fff;
    }
    .pill.result.good{ background: rgba(180,131,61,.15); }
    .pill.result.perfect{ background: rgba(180,131,61,.28); }
    .pill.result.bad{ background: rgba(198,47,47,.12); border-color: rgba(198,47,47,.30); }

    .shotMeta{
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      word-break: break-word;
    }

    .shotActions{
      display:flex;
      gap:8px;
      flex: 0 0 auto;
    }
    .iconBtn{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      border: 2px solid var(--line);
      background:#fff;
      box-shadow: 0 6px 10px rgba(102,55,27,.10);
      cursor:pointer;
      font-weight: 900;
      color: var(--text);
    }

    .empty{
      padding: 16px;
      border-radius: var(--radius-lg);
      border: 2px dashed var(--line);
      background: rgba(255,255,255,.55);
      color: var(--muted);
      font-weight: 750;
    }

    /* Modal */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.30);
      display:none;
      align-items: flex-end;
      justify-content: center;
      padding: 12px;
      z-index: 100;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: min(860px, 100%);
      background: #fff;
      border-radius: 28px;
      border: 2px solid var(--line);
      box-shadow: 0 22px 40px rgba(0,0,0,.18);
      overflow:hidden;
      max-height: calc(100vh - 24px);
      display:flex;
      flex-direction:column;
    }
    .modalHeader{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(247,241,225,.65);
    }
    .modalHeader h2{
      margin:0;
      font-size: 18px;
      font-weight: 900;
    }
    .modalBody{
      padding: 14px;
      overflow:auto;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 420px){
      .grid3{ grid-template-columns: 1fr 1fr; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .label{
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .02em;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .chip{
      border-radius: 999px;
      border: 2px solid var(--line);
      padding: 9px 12px;
      background:#fff;
      font-size: 13.5px;
      font-weight: 850;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 6px 10px rgba(102,55,27,.10);
    }
    .chip.active{
      background: var(--accent);
      color:#fff;
      border-color: rgba(102,55,27,.45);
      box-shadow: var(--shadow);
    }

    .mutedHelp{
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
      font-weight: 700;
    }

    .danger{
      border-color: rgba(198,47,47,.35) !important;
      color: #8a1d1d !important;
      background: rgba(198,47,47,.10) !important;
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="headerInner">
      <div class="headerRow">
        <div class="brand">
          <img src="coffee_129913.png" alt="Coffee icon">
          <div class="brandTitle">
            <p class="h1">Espresso Tracker</p>
            <p class="sub" id="todayLabel">Today ¬∑ ‚Äî</p>
          </div>
        </div>

        <div class="topActions">
          <button class="btn primary" id="newShotBtn">+ New Shot</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div class="toolbar">
          <button class="btn" id="exportBtn">Export</button>
          <button class="btn" id="importBtn">Import</button>
        </div>

        <div class="fileRow">
          <input type="file" id="fileInput" accept="application/json,.json" />
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="row" style="align-items:flex-start">
        <div style="flex:1; min-width:260px">
          <div class="sectionTitle">Range</div>
          <div class="seg" id="rangeSeg">
            <button data-range="today" class="active">Today</button>
            <button data-range="week">This Week (Mon‚ÄìSun)</button>
            <button data-range="month">Month</button>
          </div>
        </div>

        <div style="width:240px; max-width:100%">
          <div class="sectionTitle">Sorted by</div>
          <select id="sortSelect">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="stats" id="statsGrid">
        <div class="stat">
          <div class="k">Shots</div>
          <div class="v" id="statShots">0</div>
        </div>
        <div class="stat">
          <div class="k">Beans</div>
          <div class="v" id="statBeans">0</div>
        </div>
        <div class="stat">
          <div class="k">Good/Perfect</div>
          <div class="v" id="statGood">0%</div>
        </div>
        <div class="stat">
          <div class="k">Avg Time</div>
          <div class="v" id="statAvgTime">‚Äî</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="list" id="shotList"></div>
    </div>
  </div>

  <!-- Modal: New Shot -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="New Shot">
      <div class="modalHeader">
        <div>
          <h2>New Shot</h2>
          <div class="mutedHelp">Fast log ¬∑ keeps your workflow calm</div>
        </div>
        <div style="display:flex; gap:10px">
          <button class="btn" id="closeModalBtn">Cancel</button>
          <button class="btn primary" id="saveShotBtn">Save</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="field">
          <div class="label">Date</div>
          <select id="dateSelect">
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
          </select>
          <div class="mutedHelp">Choose ‚ÄúYesterday‚Äù to re-log past shots.</div>
        </div>

        <div style="height:12px"></div>

        <div class="grid2">
          <div class="field">
            <div class="label">Bean</div>
            <input id="beanInput" type="text" placeholder="Type bean name (e.g., Mt Apo)..." />
            <div class="mutedHelp">Tip: keep names consistent for cleaner stats.</div>
          </div>

          <div class="field">
            <div class="label">Bean Type</div>
            <select id="beanTypeSelect">
              <option value="Arabica">Arabica</option>
              <option value="Robusta">Robusta</option>
              <option value="Liberica">Liberica</option>
              <option value="Custom Blend">Custom Blend</option>
            </select>
            <input id="blendInput" type="text" placeholder="Describe blend (e.g., 70/30)" style="margin-top:10px; display:none;">
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="field">
          <div class="label">Roast Profile</div>
          <div class="chips" id="roastChips">
            <div class="chip" data-value="Light">Light</div>
            <div class="chip" data-value="Light‚ÄìMed">Light‚ÄìMed</div>
            <div class="chip active" data-value="Medium">Medium</div>
            <div class="chip" data-value="Med‚ÄìDark">Med‚ÄìDark</div>
            <div class="chip" data-value="Dark">Dark</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="grid2">
          <div class="field">
            <div class="label">Brew Method</div>
            <select id="brewSelect">
              <option value="Espresso">Espresso</option>
              <option value="Ristretto">Ristretto</option>
              <option value="Lungo">Lungo</option>
              <option value="Americano">Americano</option>
              <option value="Pour Over">Pour Over</option>
              <option value="Moka Pot">Moka Pot</option>
            </select>
          </div>
          <div class="field">
            <div class="label">Result Tag</div>
            <div class="chips" id="resultChips">
              <div class="chip" data-value="Perfect">Perfect</div>
              <div class="chip active" data-value="Good">Good</div>
              <div class="chip" data-value="Too Fast">Too Fast</div>
              <div class="chip" data-value="Too Runny">Too Runny</div>
              <div class="chip" data-value="Too Tight">Too Tight</div>
              <div class="chip" data-value="Bitter">Bitter</div>
              <div class="chip" data-value="Sour">Sour</div>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="grid2">
          <div class="field">
            <div class="label">Grind</div>
            <input id="grindInput" type="number" inputmode="numeric" step="1" min="0" placeholder="e.g., 30">
          </div>
          <div class="field">
            <div class="label">Dose (g)</div>
            <input id="doseInput" type="number" inputmode="decimal" step="0.1" min="0" placeholder="e.g., 18">
          </div>

          <div class="field">
            <div class="label">Yield (ml)</div>
            <input id="yieldInput" type="number" inputmode="decimal" step="0.5" min="0" placeholder="e.g., 36">
          </div>
          <div class="field">
            <div class="label">Time (s)</div>
            <input id="timeInput" type="number" inputmode="numeric" step="1" min="0" placeholder="e.g., 28">
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="field">
          <div class="label">Notes (optional)</div>
          <textarea id="notesInput" placeholder="Quick notes: puck prep, taste, adjustments..."></textarea>
        </div>

        <div style="height:12px"></div>

        <button class="btn danger" id="clearDraftBtn" type="button">Clear draft fields</button>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * Storage + Utilities
     **********************/
    const STORAGE_KEY = "espresso_tracker_shots_v1";
    const DRAFT_KEY = "espresso_tracker_draft_v1";
    const UI_KEY = "espresso_tracker_ui_v1";

    const $ = (sel) => document.querySelector(sel);

    function pad2(n){ return String(n).padStart(2,"0"); }
    function toISODateLocal(d){
      // Local date YYYY-MM-DD
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function startOfWeekMonday(d){
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const day = x.getDay(); // 0 Sun..6 Sat
      const diff = (day === 0) ? -6 : (1 - day);
      x.setDate(x.getDate() + diff);
      x.setHours(0,0,0,0);
      return x;
    }
    function endOfWeekSunday(d){
      const s = startOfWeekMonday(d);
      const e = new Date(s);
      e.setDate(e.getDate() + 6);
      e.setHours(23,59,59,999);
      return e;
    }
    function startOfMonth(d){
      const s = new Date(d.getFullYear(), d.getMonth(), 1);
      s.setHours(0,0,0,0);
      return s;
    }
    function endOfMonth(d){
      const e = new Date(d.getFullYear(), d.getMonth()+1, 0);
      e.setHours(23,59,59,999);
      return e;
    }
    function safeParseJSON(text){
      try { return { ok:true, data: JSON.parse(text) }; }
      catch(e){ return { ok:false, error: e }; }
    }
    function download(filename, text){
      const blob = new Blob([text], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function uid(){
      return Math.random().toString(36).slice(2,9) + "-" + Date.now().toString(36);
    }

    /**********************
     * Data
     **********************/
    let shots = loadShots();
    let range = loadUI().range ?? "today";
    let sort = loadUI().sort ?? "newest";

    function loadShots(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const parsed = safeParseJSON(raw);
      if(!parsed.ok) return [];
      if(Array.isArray(parsed.data)) return parsed.data;
      if(parsed.data && Array.isArray(parsed.data.shots)) return parsed.data.shots;
      return [];
    }
    function saveShots(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(shots));
    }
    function loadDraft(){
      const raw = localStorage.getItem(DRAFT_KEY);
      if(!raw) return null;
      const parsed = safeParseJSON(raw);
      if(!parsed.ok) return null;
      return parsed.data;
    }
    function saveDraft(d){
      localStorage.setItem(DRAFT_KEY, JSON.stringify(d));
    }
    function clearDraft(){
      localStorage.removeItem(DRAFT_KEY);
    }
    function loadUI(){
      const raw = localStorage.getItem(UI_KEY);
      if(!raw) return {};
      const parsed = safeParseJSON(raw);
      if(!parsed.ok) return {};
      return parsed.data || {};
    }
    function saveUI(){
      localStorage.setItem(UI_KEY, JSON.stringify({ range, sort }));
    }

    /**********************
     * Elements
     **********************/
    const todayLabel = $("#todayLabel");
    const newShotBtn = $("#newShotBtn");
    const exportBtn = $("#exportBtn");
    const importBtn = $("#importBtn");
    const fileInput = $("#fileInput");

    const rangeSeg = $("#rangeSeg");
    const sortSelect = $("#sortSelect");
    const shotList = $("#shotList");

    const statShots = $("#statShots");
    const statBeans = $("#statBeans");
    const statGood = $("#statGood");
    const statAvgTime = $("#statAvgTime");

    const modalOverlay = $("#modalOverlay");
    const closeModalBtn = $("#closeModalBtn");
    const saveShotBtn = $("#saveShotBtn");

    const dateSelect = $("#dateSelect");
    const beanInput = $("#beanInput");
    const beanTypeSelect = $("#beanTypeSelect");
    const blendInput = $("#blendInput");
    const roastChips = $("#roastChips");
    const brewSelect = $("#brewSelect");
    const resultChips = $("#resultChips");
    const grindInput = $("#grindInput");
    const doseInput = $("#doseInput");
    const yieldInput = $("#yieldInput");
    const timeInput = $("#timeInput");
    const notesInput = $("#notesInput");
    const clearDraftBtn = $("#clearDraftBtn");

    /**********************
     * Init
     **********************/
    function setTodayLabel(){
      const now = new Date();
      todayLabel.textContent = `Today ¬∑ ${toISODateLocal(now)}`;
    }

    function setActiveSeg(){
      [...rangeSeg.querySelectorAll("button")].forEach(b=>{
        b.classList.toggle("active", b.dataset.range === range);
      });
      sortSelect.value = sort;
    }

    function chipGroupSetActive(container, value){
      [...container.querySelectorAll(".chip")].forEach(c=>{
        c.classList.toggle("active", c.dataset.value === value);
      });
    }
    function chipGroupGetValue(container){
      const el = container.querySelector(".chip.active");
      return el ? el.dataset.value : "";
    }

    function openModal(){
      // Load last draft or last shot defaults
      const draft = loadDraft();
      const last = shots.length ? shots[shots.length-1] : null;

      // Date default
      dateSelect.value = draft?.datePreset ?? "today";

      beanInput.value = draft?.bean ?? (last?.bean ?? "");
      beanTypeSelect.value = draft?.beanType ?? (last?.beanType ?? "Arabica");

      // Blend visibility
      toggleBlend(beanTypeSelect.value);
      blendInput.value = draft?.blend ?? (last?.blend ?? "");

      chipGroupSetActive(roastChips, draft?.roastProfile ?? (last?.roastProfile ?? "Medium"));
      brewSelect.value = draft?.brewMethod ?? (last?.brewMethod ?? "Espresso");
      chipGroupSetActive(resultChips, draft?.result ?? (last?.result ?? "Good"));

      grindInput.value = (draft?.grind ?? last?.grind ?? "");
      doseInput.value = (draft?.dose ?? last?.dose ?? "");
      yieldInput.value = (draft?.yield ?? last?.yield ?? "");
      timeInput.value = (draft?.time ?? last?.time ?? "");
      notesInput.value = (draft?.notes ?? "");

      modalOverlay.classList.add("show");
      modalOverlay.setAttribute("aria-hidden","false");
      // focus
      setTimeout(()=> beanInput.focus(), 50);
    }

    function closeModal(){
      modalOverlay.classList.remove("show");
      modalOverlay.setAttribute("aria-hidden","true");
    }

    function toggleBlend(beanType){
      if(beanType === "Custom Blend"){
        blendInput.style.display = "block";
      } else {
        blendInput.style.display = "none";
        blendInput.value = "";
      }
    }

    function getSelectedDateISO(){
      const now = new Date();
      if(dateSelect.value === "yesterday"){
        const y = new Date(now);
        y.setDate(now.getDate()-1);
        return toISODateLocal(y);
      }
      return toISODateLocal(now);
    }

    function normalizeNumber(val){
      if(val === "" || val === null || typeof val === "undefined") return null;
      const n = Number(val);
      return Number.isFinite(n) ? n : null;
    }

    function saveShot(){
      const dateISO = getSelectedDateISO();
      const roastProfile = chipGroupGetValue(roastChips) || "Medium";
      const result = chipGroupGetValue(resultChips) || "Good";
      const beanType = beanTypeSelect.value;

      const shot = {
        id: uid(),
        date: dateISO,
        ts: new Date().toISOString(),
        bean: (beanInput.value || "").trim(),
        beanType,
        blend: beanType === "Custom Blend" ? (blendInput.value || "").trim() : "",
        roastProfile,
        brewMethod: brewSelect.value,
        grind: normalizeNumber(grindInput.value),
        dose: normalizeNumber(doseInput.value),
        yield: normalizeNumber(yieldInput.value),
        time: normalizeNumber(timeInput.value),
        result,
        notes: (notesInput.value || "").trim()
      };

      // Minimal validation (keep it forgiving)
      if(!shot.bean){
        alert("Please enter a bean name.");
        beanInput.focus();
        return;
      }

      shots.push(shot);
      saveShots();
      clearDraft();
      closeModal();
      render();
    }

    function saveDraftFromInputs(){
      const d = {
        datePreset: dateSelect.value,
        bean: beanInput.value,
        beanType: beanTypeSelect.value,
        blend: blendInput.value,
        roastProfile: chipGroupGetValue(roastChips),
        brewMethod: brewSelect.value,
        result: chipGroupGetValue(resultChips),
        grind: grindInput.value,
        dose: doseInput.value,
        yield: yieldInput.value,
        time: timeInput.value,
        notes: notesInput.value
      };
      saveDraft(d);
    }

    /**********************
     * Filtering + Stats
     **********************/
    function inRange(shot, now){
      const d = new Date(shot.date + "T00:00:00");
      if(range === "today"){
        return shot.date === toISODateLocal(now);
      }
      if(range === "week"){
        const s = startOfWeekMonday(now);
        const e = endOfWeekSunday(now);
        return d >= s && d <= e;
      }
      if(range === "month"){
        const s = startOfMonth(now);
        const e = endOfMonth(now);
        return d >= s && d <= e;
      }
      return true;
    }

    function sortShots(arr){
      const copy = [...arr];
      copy.sort((a,b)=>{
        const ta = new Date(a.ts || (a.date+"T00:00:00")).getTime();
        const tb = new Date(b.ts || (b.date+"T00:00:00")).getTime();
        return sort === "newest" ? (tb - ta) : (ta - tb);
      });
      return copy;
    }

    function computeStats(filtered){
      const total = filtered.length;
      const beans = new Set(filtered.map(s => (s.bean || "").trim()).filter(Boolean));
      const goodCount = filtered.filter(s => ["Good","Perfect"].includes(s.result)).length;
      const goodPct = total ? Math.round((goodCount/total)*100) : 0;

      const times = filtered.map(s => s.time).filter(n => typeof n === "number" && Number.isFinite(n));
      const avgTime = times.length ? Math.round(times.reduce((a,b)=>a+b,0) / times.length) : null;

      return { total, beansCount: beans.size, goodPct, avgTime };
    }

    function resultClass(result){
      if(result === "Perfect") return "perfect";
      if(result === "Good") return "good";
      if(["Too Fast","Too Runny","Too Tight","Bitter","Sour"].includes(result)) return "bad";
      return "";
    }

    /**********************
     * Render
     **********************/
    function render(){
      setTodayLabel();
      setActiveSeg();

      const now = new Date();
      const filtered = shots.filter(s => inRange(s, now));
      const sorted = sortShots(filtered);

      const stats = computeStats(sorted);
      statShots.textContent = stats.total;
      statBeans.textContent = stats.beansCount;
      statGood.textContent = `${stats.goodPct}%`;
      statAvgTime.textContent = stats.avgTime === null ? "‚Äî" : `${stats.avgTime}s`;

      shotList.innerHTML = "";

      if(sorted.length === 0){
        const div = document.createElement("div");
        div.className = "empty";
        div.textContent = "No shots in this range.";
        shotList.appendChild(div);
        return;
      }

      sorted.forEach(s=>{
        const item = document.createElement("div");
        item.className = "shotItem";

        const main = document.createElement("div");
        main.className = "shotMain";

        const top = document.createElement("div");
        top.className = "shotTop";

        const pillDate = document.createElement("span");
        pillDate.className = "pill";
        pillDate.textContent = s.date;

        const pillResult = document.createElement("span");
        pillResult.className = `pill result ${resultClass(s.result)}`;
        pillResult.textContent = s.result || "‚Äî";

        const pillRoast = document.createElement("span");
        pillRoast.className = "pill";
        pillRoast.textContent = s.roastProfile || "‚Äî";

        top.appendChild(pillDate);
        top.appendChild(pillResult);
        top.appendChild(pillRoast);

        const meta = document.createElement("div");
        meta.className = "shotMeta";

        const parts = [];
        parts.push(`<strong>${escapeHtml(s.bean)}</strong>`);
        if(s.beanType) parts.push(`${escapeHtml(s.beanType)}${s.beanType==="Custom Blend" && s.blend ? " ("+escapeHtml(s.blend)+")" : ""}`);
        if(s.brewMethod) parts.push(`${escapeHtml(s.brewMethod)}`);

        const recipe = [];
        if(typeof s.grind === "number") recipe.push(`Grind ${s.grind}`);
        if(typeof s.dose === "number") recipe.push(`Dose ${s.dose}g`);
        if(typeof s.yield === "number") recipe.push(`Yield ${s.yield}ml`);
        if(typeof s.time === "number") recipe.push(`Time ${s.time}s`);
        if(recipe.length) parts.push(recipe.join(" ¬∑ "));

        if(s.notes) parts.push(`üìù ${escapeHtml(s.notes)}`);

        meta.innerHTML = parts.join("<br>");

        main.appendChild(top);
        main.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "shotActions";

        const delBtn = document.createElement("button");
        delBtn.className = "iconBtn";
        delBtn.title = "Delete";
        delBtn.textContent = "√ó";
        delBtn.addEventListener("click", ()=>{
          if(confirm("Delete this shot?")){
            shots = shots.filter(x => x.id !== s.id);
            saveShots();
            render();
          }
        });

        actions.appendChild(delBtn);

        item.appendChild(main);
        item.appendChild(actions);

        shotList.appendChild(item);
      });
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /**********************
     * Events
     **********************/
    newShotBtn.addEventListener("click", openModal);
    closeModalBtn.addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", (e)=>{
      if(e.target === modalOverlay) closeModal();
    });

    // Range toggle
    rangeSeg.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-range]");
      if(!btn) return;
      range = btn.dataset.range;
      saveUI();
      render();
    });

    sortSelect.addEventListener("change", ()=>{
      sort = sortSelect.value;
      saveUI();
      render();
    });

    // Chips selection (roast + result)
    roastChips.addEventListener("click", (e)=>{
      const chip = e.target.closest(".chip");
      if(!chip) return;
      chipGroupSetActive(roastChips, chip.dataset.value);
      saveDraftFromInputs();
    });
    resultChips.addEventListener("click", (e)=>{
      const chip = e.target.closest(".chip");
      if(!chip) return;
      chipGroupSetActive(resultChips, chip.dataset.value);
      saveDraftFromInputs();
    });

    beanTypeSelect.addEventListener("change", ()=>{
      toggleBlend(beanTypeSelect.value);
      saveDraftFromInputs();
    });

    // Save draft on input changes (so you don‚Äôt lose mid-entry)
    [
      dateSelect, beanInput, blendInput, brewSelect,
      grindInput, doseInput, yieldInput, timeInput, notesInput
    ].forEach(el=>{
      el.addEventListener("input", saveDraftFromInputs);
      el.addEventListener("change", saveDraftFromInputs);
    });

    clearDraftBtn.addEventListener("click", ()=>{
      if(confirm("Clear draft fields?")){
        clearDraft();
        // reset modal fields quickly
        dateSelect.value = "today";
        beanInput.value = "";
        beanTypeSelect.value = "Arabica";
        toggleBlend("Arabica");
        chipGroupSetActive(roastChips, "Medium");
        brewSelect.value = "Espresso";
        chipGroupSetActive(resultChips, "Good");
        grindInput.value = "";
        doseInput.value = "";
        yieldInput.value = "";
        timeInput.value = "";
        notesInput.value = "";
      }
    });

    saveShotBtn.addEventListener("click", saveShot);

    // Export / Import
    exportBtn.addEventListener("click", ()=>{
      const fname = `espresso-shots-${toISODateLocal(new Date())}.json`;
      download(fname, JSON.stringify(shots, null, 2));
    });

    importBtn.addEventListener("click", ()=>{
      fileInput.click();
    });

    fileInput.addEventListener("change", async ()=>{
      const file = fileInput.files?.[0];
      if(!file) return;

      const text = await file.text();
      const parsed = safeParseJSON(text);
      if(!parsed.ok){
        alert("Invalid JSON file.");
        fileInput.value = "";
        return;
      }

      let incoming = null;
      if(Array.isArray(parsed.data)) incoming = parsed.data;
      else if(parsed.data && Array.isArray(parsed.data.shots)) incoming = parsed.data.shots;

      if(!incoming){
        alert("JSON must be an array of shots (or { shots: [...] }).");
        fileInput.value = "";
        return;
      }

      // Basic normalization + merge strategy:
      // Replace all (cleanest for you, since you do backups)
      if(!confirm(`Import will REPLACE current data with ${incoming.length} shots. Continue?`)){
        fileInput.value = "";
        return;
      }

      shots = incoming.map(s => ({
        id: s.id || uid(),
        date: s.date || toISODateLocal(new Date()),
        ts: s.ts || new Date().toISOString(),
        bean: (s.bean || "").trim(),
        beanType: s.beanType || "Arabica",
        blend: s.blend || "",
        roastProfile: s.roastProfile || s.roast || "Medium",
        brewMethod: s.brewMethod || "Espresso",
        grind: (typeof s.grind === "number") ? s.grind : normalizeNumber(s.grind),
        dose: (typeof s.dose === "number") ? s.dose : normalizeNumber(s.dose),
        yield: (typeof s.yield === "number") ? s.yield : normalizeNumber(s.yield),
        time: (typeof s.time === "number") ? s.time : normalizeNumber(s.time),
        result: s.result || "Good",
        notes: s.notes || ""
      }));

      saveShots();
      render();
      fileInput.value = "";
      alert("Import complete.");
    });

    // Close modal on ESC
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal();
    });

    // Initial
    render();
  </script>
</body>
</html>
