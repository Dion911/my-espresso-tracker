<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Espresso Tracker — Service Mode</title>

<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">

<style>
:root{
  --bg:#fafafa; --panel:#fff; --text:#101113; --muted:#6b6e76;
  --line:#e8e8ea; --hover:#f4f4f5; --danger:#c62f2f;
  --radius:18px; --sans:-apple-system,BlinkMacSystemFont,Inter,system-ui,Arial;
}
*{box-sizing:border-box}
body{margin:0;font-family:var(--sans);background:var(--bg);color:var(--text)}
.wrap{max-width:820px;margin:0 auto;padding:14px}

.top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.title{font-weight:800;font-size:28px;letter-spacing:-0.02em}
.subtitle{font-size:15px;color:var(--muted);margin-top:2px}

.btn{
  border:1px solid var(--line);
  background:#fff;
  border-radius:16px;
  padding:11px 13px;
  font-weight:700;
  cursor:pointer;
  font-size:16px;
}
.btnPrimary{background:#101113;color:#fff;border-color:#101113}
.btnDanger{color:var(--danger);border-color:#f2c6c6}
.btnGhost{background:transparent}
.btnSmall{padding:9px 11px;border-radius:14px;font-size:15px}

.card{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:22px;
  padding:16px;
}
.list{display:flex;flex-direction:column;gap:12px}

.chips{display:flex;gap:10px;flex-wrap:wrap}
.chip{
  padding:9px 13px;
  border-radius:999px;
  border:1px solid var(--line);
  font-size:15px;
  cursor:pointer;
  user-select:none;
}
.chip.active{background:#101113;color:#fff;border-color:#101113}

input,select,textarea{
  width:100%;
  padding:13px 14px;
  border-radius:16px;
  border:1px solid var(--line);
  font-size:18px;
  outline:none;
}
textarea{min-height:92px;resize:vertical}
label{font-size:15px;color:var(--muted);display:block;margin-top:14px;margin-bottom:8px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.hidden{display:none}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

.kicker{font-size:15px;color:var(--muted);margin-top:4px}
.beanName{font-weight:800;font-size:23px;line-height:1.12}
.metaLine{font-size:18px;color:#1a1b1f;letter-spacing:-0.01em;margin-top:8px}
.metaMuted{font-size:17px;color:var(--muted);margin-top:6px}
.actions{display:flex;gap:10px;margin-top:12px}
.actions .btn{min-width:110px}

.flavorBlock{margin-top:6px}
.flavorRow{margin-top:10px}
.flavorTitle{font-size:15px;color:var(--muted);margin-bottom:8px}

.footerBtns{margin-top:16px}
.footerBtns .btnPrimary{width:100%;padding:16px 16px;border-radius:22px;font-size:18px}
.footerBtns .btnDanger{margin-top:12px}

.summaryBar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:flex-start;
  justify-content:space-between;
  margin:10px 0 14px;
}
.summaryTabs{display:flex;gap:8px;flex-wrap:wrap}
.statPills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

.pill{
  border:1px solid var(--line);
  background:#fff;
  border-radius:999px;
  padding:8px 12px;
  font-size:14px;
  color:var(--muted);
  font-weight:700;
}

.sortRow{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.sortLabel{
  font-size:14px;
  color:var(--muted);
  font-weight:800;
  letter-spacing:0.01em;
}
.sortSelect{
  width:auto;
  padding:9px 12px;
  border-radius:999px;
  font-size:14px;
  font-weight:800;
  color:#1a1b1f;
}

.dayHeader{
  font-size:14px;
  color:var(--muted);
  font-weight:800;
  letter-spacing:0.01em;
  padding:6px 2px 0;
}

.badge{
  display:inline-flex; align-items:center; gap:6px;
  border:1px solid var(--line);
  border-radius:999px;
  padding:6px 10px;
  font-size:14px;
  color:var(--muted);
  font-weight:800;
  margin-top:10px;
}
.dot{width:8px;height:8px;border-radius:999px;background:#bbb}

.help{font-size:13px;color:var(--muted);line-height:1.35;margin-top:8px}

@media (max-width:420px){
  .wrap{padding:12px}
  .title{font-size:26px}
  .beanName{font-size:22px}
  .metaLine{font-size:17px}
  .metaMuted{font-size:16px}
}
</style>
</head>

<body>
<div class="wrap">

<!-- SERVICE MODE -->
<section id="service">
  <div class="top">
    <div>
      <div class="title">Espresso Tracker</div>
      <div class="subtitle" id="today"></div>
      <div class="subtitle" id="rangeSubtitle" style="margin-top:6px"></div>
    </div>
  </div>

  <button class="btn btnPrimary" style="width:100%;margin:10px 0 12px" id="btnNewTop">＋ New Shot</button>

  <!-- Backup buttons -->
  <div class="row" style="gap:10px;margin-bottom:12px">
    <button class="btn btnSmall" id="btnExport" type="button">Export</button>
    <button class="btn btnSmall" id="btnImport" type="button">Import</button>
    <input id="importFile" type="file" accept="application/json" class="hidden">
  </div>

  <!-- Summary + Range Tabs + Sort -->
  <div class="summaryBar">
    <div class="summaryTabs chips" id="rangeTabs"></div>

    <div class="statPills">
      <div id="stats" class="statPills"></div>
      <div class="sortRow">
        <div class="sortLabel">Sorted by</div>
        <select id="sortSelect" class="sortSelect">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="bean">Bean</option>
        </select>
      </div>
    </div>
  </div>

  <div class="list" id="shotList"></div>
</section>

<!-- NEW SHOT -->
<section id="new" class="hidden">
  <div class="top">
    <div>
      <div class="title" id="formTitle">New Shot</div>
      <div class="kicker" id="formKicker">Fast log</div>
    </div>
    <button class="btn btnGhost" id="btnCancel">Cancel</button>
  </div>

  <!-- DATE PICKER -->
  <label>Date</label>
  <div class="chips" id="dateChips"></div>
  <div class="help">Choose “Yesterday” to re-log past shots.</div>

  <label>Bean</label>
  <div class="row">
    <input id="bean" list="beanList" placeholder="Type bean name…" autocomplete="off">
    <button class="btn btnSmall" id="btnAddBean" type="button">Add</button>
  </div>
  <datalist id="beanList"></datalist>

  <label>Bean Type</label>
  <div class="chips" id="beanTypeChips"></div>
  <input id="customBlend" class="hidden" placeholder="Describe blend (e.g., 70/30 Arabica-Robusta)">

  <label>Roast Profile</label>
  <div class="chips" id="roastChips"></div>

  <label>Brew Method</label>
  <select id="brewMethod">
    <option value="Espresso">Espresso</option>
    <option value="Pour Over">Pour Over</option>
    <option value="Cold Brew">Cold Brew</option>
  </select>

  <div id="fieldsBlock">
    <div class="grid2" style="margin-top:10px">
      <div>
        <label id="lblGrind" style="margin-top:0">Grind</label>
        <input id="grind" placeholder="30">
      </div>
      <div>
        <label id="lblDose" style="margin-top:0">Dose</label>
        <input id="dose" placeholder="18g">
      </div>
      <div>
        <label id="lblYield" style="margin-top:0">Yield</label>
        <input id="yield" placeholder="36g / 30ml">
      </div>
      <div>
        <label id="lblTime" style="margin-top:0">Time</label>
        <input id="time" placeholder="28s">
      </div>
    </div>
  </div>

  <label>Flavor Profile</label>
  <div class="flavorBlock" id="flavorBlock"></div>

  <label>Result</label>
  <div class="chips" id="resultChips"></div>
  <input id="resultCustom" class="hidden" placeholder="Custom result (e.g., Channeling, Under-extracted)">

  <label>Notes</label>
  <textarea id="notes" placeholder="Quick notes… (optional)"></textarea>

  <div class="footerBtns">
    <button class="btn btnPrimary" id="btnSave">Save</button>
    <button class="btn btnDanger hidden" id="btnDelete">Delete</button>
  </div>
</section>

</div>

<script>
/** Storage keys */
const STORAGE_SHOTS = 'shots';
const STORAGE_BEANS = 'beanLibrary';

let shots = safeParse(localStorage.getItem(STORAGE_SHOTS), []);
let beanLibrary = safeParse(localStorage.getItem(STORAGE_BEANS), []);

let view = 'service';
let editingId = null;

const BEAN_TYPES = ['Arabica','Robusta','Liberica','Custom Blend'];
const ROAST_PROFILES = ['Light','Light–Med','Medium','Med–Dark','Dark'];

const FLAVOR_KEYS = [
  { key:'acidity', label:'Acidity' },
  { key:'sweetness', label:'Sweetness' },
  { key:'body', label:'Body' },
  { key:'bitterness', label:'Bitterness' }
];
const FLAVOR_LEVELS = ['Low','Med','High'];

const RESULT_TAGS = [
  'Perfect','Good','Too Fast','Too Runny','Too Tight','Bitter','Sour','Custom'
];

const RANGE_TABS = [
  { key:'today', label:'Today' },
  { key:'thisWeek', label:'This Week (Mon–Sun)' },
  { key:'month', label:'Month' }
];

let range = 'today';
let sortMode = 'newest';

/** Date logging */
let selectedDate = todayKey(); // default today

const els = {
  service: document.getElementById('service'),
  new: document.getElementById('new'),
  today: document.getElementById('today'),
  rangeSubtitle: document.getElementById('rangeSubtitle'),
  shotList: document.getElementById('shotList'),
  stats: document.getElementById('stats'),
  rangeTabs: document.getElementById('rangeTabs'),
  sortSelect: document.getElementById('sortSelect'),

  btnNewTop: document.getElementById('btnNewTop'),
  btnCancel: document.getElementById('btnCancel'),
  btnSave: document.getElementById('btnSave'),
  btnDelete: document.getElementById('btnDelete'),
  btnAddBean: document.getElementById('btnAddBean'),

  btnExport: document.getElementById('btnExport'),
  btnImport: document.getElementById('btnImport'),
  importFile: document.getElementById('importFile'),

  dateChips: document.getElementById('dateChips'),

  formTitle: document.getElementById('formTitle'),
  formKicker: document.getElementById('formKicker'),

  bean: document.getElementById('bean'),
  beanList: document.getElementById('beanList'),

  beanTypeChips: document.getElementById('beanTypeChips'),
  customBlend: document.getElementById('customBlend'),

  roastChips: document.getElementById('roastChips'),

  brewMethod: document.getElementById('brewMethod'),

  lblGrind: document.getElementById('lblGrind'),
  lblDose: document.getElementById('lblDose'),
  lblYield: document.getElementById('lblYield'),
  lblTime: document.getElementById('lblTime'),

  grind: document.getElementById('grind'),
  dose: document.getElementById('dose'),
  yield: document.getElementById('yield'),
  time: document.getElementById('time'),

  flavorBlock: document.getElementById('flavorBlock'),

  resultChips: document.getElementById('resultChips'),
  resultCustom: document.getElementById('resultCustom'),

  notes: document.getElementById('notes')
};

let currentBeanType = 'Arabica';
let currentRoast = 'Medium';

let currentFlavor = { acidity:null, sweetness:null, body:null, bitterness:null };
let currentResultTag = null;
let currentResultCustom = '';

init();

function init(){
  els.today.textContent = `Today · ${fmtDate(new Date())}`;

  renderRangeTabs();
  renderDateChips();
  renderBeanTypeChips();
  renderRoastChips();
  renderFlavorChips();
  renderResultChips();

  normalizeBeanLibrary();
  renderBeanDatalist();

  els.btnNewTop.addEventListener('click', openNew);
  els.btnCancel.addEventListener('click', backToService);
  els.btnSave.addEventListener('click', saveShot);
  els.btnDelete.addEventListener('click', deleteCurrentShot);
  els.btnAddBean.addEventListener('click', addBeanFromPrompt);

  els.brewMethod.addEventListener('change', applyMethodLabels);

  els.sortSelect.addEventListener('change', ()=>{
    sortMode = els.sortSelect.value || 'newest';
    renderService();
  });

  // Backup handlers
  els.btnExport.addEventListener('click', exportData);
  els.btnImport.addEventListener('click', ()=> els.importFile.click());
  els.importFile.addEventListener('change', importData);

  applyMethodLabels();
  render();
}

/* ---------- Date helpers ---------- */
function yesterdayKey(){
  const d = new Date();
  d.setDate(d.getDate() - 1);
  return todayKey(d);
}

function renderDateChips(){
  const options = [
    { key: todayKey(), label: 'Today' },
    { key: yesterdayKey(), label: 'Yesterday' }
  ];

  els.dateChips.innerHTML = '';
  options.forEach(opt=>{
    const c = document.createElement('div');
    c.className = 'chip' + (opt.key === selectedDate ? ' active' : '');
    c.textContent = opt.label;
    c.addEventListener('click', ()=>{
      selectedDate = opt.key;
      renderDateChips();
    });
    els.dateChips.appendChild(c);
  });
}

/* ---------- Range helpers ---------- */
function weekMonSunBounds(now=new Date()){
  const day = now.getDay(); // 0=Sun, 1=Mon
  const diffToMon = (day === 0 ? -6 : 1 - day);

  const start = new Date(now);
  start.setDate(now.getDate() + diffToMon);
  start.setHours(0,0,0,0);

  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  end.setHours(23,59,59,999);

  return { start, end };
}

function shortMD(d){
  return d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' });
}

function prettyDayLabel(dateStr){
  const today = todayKey();
  const y = new Date();
  y.setDate(y.getDate() - 1);
  const yesterday = todayKey(y);

  if(dateStr === today) return 'Today';
  if(dateStr === yesterday) return 'Yesterday';

  const d = new Date(dateStr + 'T00:00:00');
  if(Number.isNaN(d.getTime())) return dateStr;

  return d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' });
}

/* ---------- Storage ---------- */
function safeParse(txt, fallback){
  try{ return txt ? JSON.parse(txt) : fallback; } catch(e){ return fallback; }
}

function persist(){
  localStorage.setItem(STORAGE_SHOTS, JSON.stringify(shots));
  localStorage.setItem(STORAGE_BEANS, JSON.stringify(beanLibrary));
}

/* ---------- Beans ---------- */
function normalizeBeanLibrary(){
  const set = new Set();
  beanLibrary.forEach(b=>{
    const t = (b||'').toString().trim();
    if(t) set.add(t);
  });
  beanLibrary = Array.from(set).sort((a,b)=>a.localeCompare(b));
  persist();
}

function renderBeanDatalist(){
  els.beanList.innerHTML = beanLibrary.map(b=>`<option value="${escapeHtml(b)}"></option>`).join('');
}

function addBeanToLibrary(name){
  const t = (name||'').toString().trim();
  if(!t) return;
  if(!beanLibrary.includes(t)){
    beanLibrary.push(t);
    normalizeBeanLibrary();
    renderBeanDatalist();
  }
}

function addBeanFromPrompt(){
  const v = prompt('Add bean name:');
  if(!v) return;
  addBeanToLibrary(v);
  els.bean.value = v.trim();
  els.bean.focus();
}

/* ---------- Chips ---------- */
function renderRangeTabs(){
  els.rangeTabs.innerHTML = '';
  RANGE_TABS.forEach(t=>{
    const c = document.createElement('div');
    c.className = 'chip' + (t.key===range ? ' active':'');
    c.textContent = t.label;
    c.addEventListener('click', ()=>{
      range = t.key;
      renderRangeTabs();
      renderService();
    });
    els.rangeTabs.appendChild(c);
  });
}

function renderBeanTypeChips(){
  els.beanTypeChips.innerHTML = '';
  BEAN_TYPES.forEach(t=>{
    const d = document.createElement('div');
    d.className = 'chip' + (t==='Arabica' ? ' active' : '');
    d.textContent = t;
    d.addEventListener('click', ()=>{
      currentBeanType = t;
      [...els.beanTypeChips.children].forEach(x=>x.classList.remove('active'));
      d.classList.add('active');
      els.customBlend.classList.toggle('hidden', t!=='Custom Blend');
      if(t!=='Custom Blend') els.customBlend.value = '';
    });
    els.beanTypeChips.appendChild(d);
  });
}

function renderRoastChips(){
  els.roastChips.innerHTML = '';
  ROAST_PROFILES.forEach(r=>{
    const c = document.createElement('div');
    c.className = 'chip' + (r === currentRoast ? ' active' : '');
    c.textContent = r;
    c.addEventListener('click', ()=>{
      currentRoast = r;
      [...els.roastChips.children].forEach(x=>x.classList.remove('active'));
      c.classList.add('active');
    });
    els.roastChips.appendChild(c);
  });
}

function applyRoastToUI(roast){
  currentRoast = roast || 'Medium';
  [...els.roastChips.children].forEach(ch=>{
    ch.classList.toggle('active', ch.textContent === currentRoast);
  });
}

function renderFlavorChips(){
  els.flavorBlock.innerHTML = '';
  FLAVOR_KEYS.forEach(row=>{
    const wrap = document.createElement('div');
    wrap.className = 'flavorRow';

    const title = document.createElement('div');
    title.className = 'flavorTitle';
    title.textContent = row.label;
    wrap.appendChild(title);

    const chips = document.createElement('div');
    chips.className = 'chips';

    FLAVOR_LEVELS.forEach(level=>{
      const c = document.createElement('div');
      c.className = 'chip';
      c.textContent = level;
      c.addEventListener('click', ()=>{
        const cur = currentFlavor[row.key];
        if(cur === level){
          currentFlavor[row.key] = null;
          c.classList.remove('active');
        }else{
          currentFlavor[row.key] = level;
          [...chips.children].forEach(x=>x.classList.remove('active'));
          c.classList.add('active');
        }
      });
      chips.appendChild(c);
    });

    wrap.appendChild(chips);
    els.flavorBlock.appendChild(wrap);
  });
}

function renderResultChips(){
  els.resultChips.innerHTML = '';
  RESULT_TAGS.forEach(tag=>{
    const c = document.createElement('div');
    c.className = 'chip';
    c.textContent = tag;
    c.addEventListener('click', ()=>{
      const was = (currentResultTag === tag);
      currentResultTag = was ? null : tag;

      [...els.resultChips.children].forEach(x=>x.classList.remove('active'));
      if(!was) c.classList.add('active');

      els.resultCustom.classList.toggle('hidden', currentResultTag !== 'Custom');
      if(currentResultTag !== 'Custom'){
        els.resultCustom.value = '';
        currentResultCustom = '';
      }
    });
    els.resultChips.appendChild(c);
  });
}

function applyFlavorToUI(flavorProfile){
  currentFlavor = {
    acidity: flavorProfile?.acidity ?? null,
    sweetness: flavorProfile?.sweetness ?? null,
    body: flavorProfile?.body ?? null,
    bitterness: flavorProfile?.bitterness ?? null
  };

  const rows = els.flavorBlock.querySelectorAll('.flavorRow');
  rows.forEach((rowEl, idx)=>{
    const key = FLAVOR_KEYS[idx].key;
    const chips = rowEl.querySelectorAll('.chip');
    chips.forEach(ch=>{
      ch.classList.toggle('active', ch.textContent === currentFlavor[key]);
    });
  });
}

function applyBeanTypeToUI(beanType){
  currentBeanType = beanType || 'Arabica';
  [...els.beanTypeChips.children].forEach(ch=>{
    ch.classList.toggle('active', ch.textContent === currentBeanType);
  });
  els.customBlend.classList.toggle('hidden', currentBeanType!=='Custom Blend');
}

function applyResultToUI(result){
  currentResultTag = result?.tag ?? null;
  currentResultCustom = result?.custom ?? '';

  [...els.resultChips.children].forEach(ch=>{
    ch.classList.toggle('active', ch.textContent === currentResultTag);
  });

  els.resultCustom.classList.toggle('hidden', currentResultTag !== 'Custom');
  els.resultCustom.value = (currentResultTag === 'Custom') ? currentResultCustom : '';
}

/* ---------- Method labels ---------- */
function applyMethodLabels(){
  const m = els.brewMethod.value;

  els.lblGrind.textContent = 'Grind';
  els.grind.placeholder = '30';
  els.grind.parentElement.classList.remove('hidden');

  if(m === 'Espresso'){
    els.grind.parentElement.classList.remove('hidden');
    els.lblDose.textContent = 'Dose';
    els.dose.placeholder = '18g';
    els.lblYield.textContent = 'Yield';
    els.yield.placeholder = '36g / 30ml';
    els.lblTime.textContent = 'Time';
    els.time.placeholder = '28s';
  } else if(m === 'Pour Over'){
    els.grind.parentElement.classList.add('hidden');
    els.lblDose.textContent = 'Dose';
    els.dose.placeholder = '18g';
    els.lblYield.textContent = 'Water';
    els.yield.placeholder = '280g';
    els.lblTime.textContent = 'Time';
    els.time.placeholder = '3:00';
  } else if(m === 'Cold Brew'){
    els.grind.parentElement.classList.add('hidden');
    els.lblDose.textContent = 'Coffee';
    els.dose.placeholder = '60g';
    els.lblYield.textContent = 'Water';
    els.yield.placeholder = '900g';
    els.lblTime.textContent = 'Brew Time';
    els.time.placeholder = '12h';
  }
}

/* ---------- Date utils ---------- */
function todayKey(d=new Date()){
  return d.toISOString().slice(0,10);
}
function fmtDate(d){
  return d.toISOString().slice(0,10);
}
function fmtTime(d){
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}
function fmtStamp(iso){
  if(!iso) return '';
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return '';
  return `${fmtDate(d)} · ${fmtTime(d)}`;
}
function getShotDateISO(s){
  if(s.createdAt) return s.createdAt;
  if(s.date) return s.date + 'T12:00:00.000Z';
  return null;
}

/* ---------- Render ---------- */
function render(){
  els.service.classList.toggle('hidden', view!=='service');
  els.new.classList.toggle('hidden', view!=='new');
  if(view==='service') renderService();
}

function withinRange(shot){
  const iso = getShotDateISO(shot);
  if(!iso) return false;
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return false;

  const now = new Date();
  const today = todayKey(now);

  if(range === 'today'){
    const date = (shot.createdAt ? shot.createdAt.slice(0,10) : shot.date);
    return date === today;
  }

  if(range === 'thisWeek'){
    const { start, end } = weekMonSunBounds(now);
    return d >= start && d <= end;
  }

  if(range === 'month'){
    const y = now.getFullYear();
    const m = now.getMonth();
    const start = new Date(y, m, 1, 0,0,0,0);
    const end = new Date(y, m + 1, 0, 23,59,59,999);
    return d >= start && d <= end;
  }

  return false;
}

function computeStats(arr){
  const total = arr.length;
  const beans = new Set(arr.map(s=> (s.bean||'').trim()).filter(Boolean));
  return { total, uniqueBeans: beans.size };
}

function renderStats(arr){
  const st = computeStats(arr);
  els.stats.innerHTML = `
    <div class="pill">${st.total} shots</div>
    <div class="pill">${st.uniqueBeans} beans</div>
  `;
}

function groupByDay(arr){
  const map = new Map();
  arr.forEach(s=>{
    const date = (s.createdAt ? s.createdAt.slice(0,10) : (s.date||''));
    if(!date) return;
    if(!map.has(date)) map.set(date, []);
    map.get(date).push(s);
  });
  return Array.from(map.entries()).sort((a,b)=> b[0].localeCompare(a[0]));
}

function sortShots(arr){
  const copy = [...arr];

  if(sortMode === 'bean'){
    copy.sort((a,b)=>{
      const A = (a.bean||'').toString().trim().toLowerCase();
      const B = (b.bean||'').toString().trim().toLowerCase();
      if(A < B) return -1;
      if(A > B) return 1;
      return (new Date(getShotDateISO(b)||0).getTime()) - (new Date(getShotDateISO(a)||0).getTime());
    });
    return copy;
  }

  if(sortMode === 'oldest'){
    copy.sort((a,b)=> (new Date(getShotDateISO(a)||0).getTime()) - (new Date(getShotDateISO(b)||0).getTime()));
    return copy;
  }

  copy.sort((a,b)=> (new Date(getShotDateISO(b)||0).getTime()) - (new Date(getShotDateISO(a)||0).getTime()));
  return copy;
}

function renderService(){
  const list = els.shotList;
  list.innerHTML = '';

  if(range === 'thisWeek'){
    const { start, end } = weekMonSunBounds(new Date());
    els.rangeSubtitle.textContent = `${shortMD(start)} – ${shortMD(end)}`;
  }else{
    els.rangeSubtitle.textContent = '';
  }

  let filtered = shots.filter(withinRange);
  filtered = sortShots(filtered);

  renderStats(filtered);

  if(filtered.length === 0){
    const empty = document.createElement('div');
    empty.className = 'card';
    empty.innerHTML = `<div class="metaMuted">No shots in this range.</div>`;
    list.appendChild(empty);
    return;
  }

  const grouped = groupByDay(filtered);

  grouped.forEach(([day, items])=>{
    const h = document.createElement('div');
    h.className = 'dayHeader';
    h.textContent = `${prettyDayLabel(day)} · ${items.length} shot${items.length>1?'s':''}`;
    list.appendChild(h);

    items.forEach(s=>{
      const card = document.createElement('div');
      card.className = 'card';

      const bean = escapeHtml(s.bean || 'Untitled bean');
      const type = escapeHtml(s.beanType || '—');
      const roast = escapeHtml(s.roastProfile || '—');
      const method = escapeHtml(s.brewMethod || 'Espresso');

      const line = formatShotLine(s);
      const stamp = fmtStamp(s.createdAt) || escapeHtml(s.date || day);

      const res = s.result?.tag ? s.result.tag : '';
      const resText = (res === 'Custom') ? (s.result.custom || 'Custom') : res;
      const resDot = resultColor(resText);

      const notePreview = (s.notes || '').trim().slice(0, 90);
      const noteLine = notePreview ? `<div class="metaMuted" style="margin-top:10px">“${escapeHtml(notePreview)}${(s.notes||'').trim().length>90?'…':''}”</div>` : '';

      card.innerHTML = `
        <div class="beanName">${bean}</div>
        <div class="metaMuted">${type} · ${roast} · ${method}</div>
        <div class="metaLine">${escapeHtml(line)}</div>
        <div class="metaMuted" style="margin-top:10px">${escapeHtml(stamp)}</div>

        ${resText ? `<div class="badge"><span class="dot" style="background:${resDot}"></span>${escapeHtml(resText)}</div>` : ''}

        ${noteLine}

        <div class="actions">
          <button class="btn btnSmall" data-action="edit" data-id="${escapeHtml(s.id)}">Edit</button>
          <button class="btn btnDanger btnSmall" data-action="delete" data-id="${escapeHtml(s.id)}">Delete</button>
        </div>
      `;

      card.querySelector('[data-action="edit"]').addEventListener('click', ()=> openEdit(s.id));
      card.querySelector('[data-action="delete"]').addEventListener('click', ()=> quickDelete(s.id));

      list.appendChild(card);
    });
  });
}

function formatShotLine(s){
  const m = s.brewMethod || 'Espresso';
  if(m === 'Pour Over') return `${s.dose||''} → ${s.yield||''} · ${s.time||''}`;
  if(m === 'Cold Brew') return `${s.dose||''} → ${s.yield||''} · ${s.time||''}`;
  return `grind ${s.grind||''} · ${s.dose||''} → ${s.yield||''} · ${s.time||''}`;
}

/* ---------- Navigation ---------- */
function openNew(){
  editingId = null;
  view = 'new';
  els.formTitle.textContent = 'New Shot';
  els.formKicker.textContent = 'Fast log';
  els.btnDelete.classList.add('hidden');

  // default date = Today
  selectedDate = todayKey();
  renderDateChips();

  const last = shots.length ? shots[shots.length-1] : null;

  els.bean.value = last?.bean || '';
  addBeanToLibrary(els.bean.value);

  applyBeanTypeToUI(last?.beanType || 'Arabica');
  els.customBlend.value = last?.customBlend || '';

  applyRoastToUI(last?.roastProfile || 'Medium');

  els.brewMethod.value = last?.brewMethod || 'Espresso';
  applyMethodLabels();

  els.grind.value = last?.grind || '';
  els.dose.value = last?.dose || '';
  els.yield.value = last?.yield || '';
  els.time.value = last?.time || '';

  applyFlavorToUI(last?.flavorProfile || {});
  applyResultToUI(last?.result || {});

  els.notes.value = '';

  render();
  els.bean.focus();
}

function openEdit(id){
  const s = shots.find(x=>x.id===id);
  if(!s) return;

  editingId = id;
  view = 'new';
  els.formTitle.textContent = 'Edit Shot';
  els.formKicker.textContent = fmtStamp(s.createdAt) || '';
  els.btnDelete.classList.remove('hidden');

  // set date chips to the shot’s date
  selectedDate = (s.createdAt ? s.createdAt.slice(0,10) : (s.date || todayKey()));
  renderDateChips();

  els.bean.value = s.bean || '';
  addBeanToLibrary(els.bean.value);

  applyBeanTypeToUI(s.beanType || 'Arabica');
  els.customBlend.value = s.customBlend || '';

  applyRoastToUI(s.roastProfile || 'Medium');

  els.brewMethod.value = s.brewMethod || 'Espresso';
  applyMethodLabels();

  els.grind.value = s.grind || '';
  els.dose.value = s.dose || '';
  els.yield.value = s.yield || '';
  els.time.value = s.time || '';

  applyFlavorToUI(s.flavorProfile || {});
  applyResultToUI(s.result || {});

  els.notes.value = s.notes || '';

  render();
}

function backToService(){
  view = 'service';
  render();
}

/* ---------- Save/delete ---------- */
function saveShot(){
  const bean = (els.bean.value || '').trim();
  if(!bean){
    alert('Please enter a bean name.');
    els.bean.focus();
    return;
  }
  addBeanToLibrary(bean);

  const beanType = currentBeanType || 'Arabica';
  const customBlend = (beanType === 'Custom Blend') ? (els.customBlend.value || '').trim() : '';
  const brewMethod = els.brewMethod.value || 'Espresso';

  const roastProfile = currentRoast || 'Medium';

  const tag = currentResultTag || null;
  const custom = (tag === 'Custom') ? (els.resultCustom.value || '').trim() : '';
  const notes = (els.notes.value || '').trim();

  // For new shots: anchor createdAt to the selected day (so Yesterday stays yesterday)
  const createdAtForNew = selectedDate + 'T12:00:00.000Z';

  const shot = {
    id: editingId || ('s_' + Math.random().toString(36).slice(2,10)),
    createdAt: editingId
      ? (shots.find(x=>x.id===editingId)?.createdAt || new Date().toISOString())
      : createdAtForNew,
    date: selectedDate,
    bean,
    beanType,
    customBlend,
    roastProfile,
    brewMethod,
    grind: (brewMethod==='Espresso') ? (els.grind.value || '').trim() : '',
    dose: (els.dose.value || '').trim(),
    yield: (els.yield.value || '').trim(),
    time: (els.time.value || '').trim(),
    flavorProfile: {
      acidity: currentFlavor.acidity,
      sweetness: currentFlavor.sweetness,
      body: currentFlavor.body,
      bitterness: currentFlavor.bitterness
    },
    result: { tag, custom },
    notes
  };

  try{
    if(editingId) shots = shots.map(x=> x.id===editingId ? shot : x);
    else shots.push(shot);
    persist();
    backToService();
  }catch(e){
    alert('Save failed — storage may be full. Try deleting old shots.');
  }
}

function deleteCurrentShot(){
  if(!editingId) return;
  quickDelete(editingId, true);
}

function quickDelete(id, fromEdit=false){
  if(!confirm('Delete this shot?')) return;
  shots = shots.filter(x=>x.id!==id);
  persist();
  if(fromEdit) backToService();
  else renderService();
}

/* ---------- Backup (Export/Import) ---------- */
function exportData(){
  const payload = {
    exportedAt: new Date().toISOString(),
    shots,
    beanLibrary
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `espresso-tracker-backup-${todayKey()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
  alert('Backup exported. Save it in Files / iCloud.');
}

function importData(evt){
  const file = evt.target.files && evt.target.files[0];
  evt.target.value = '';
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);

      if(!data || !Array.isArray(data.shots)){
        alert('Invalid backup file.');
        return;
      }

      const merge = confirm('Import backup:\n\nOK = Merge with existing\nCancel = Replace existing');

      if(merge){
        const existingIds = new Set(shots.map(s=>s.id));
        const incoming = data.shots.filter(s=>s && s.id && !existingIds.has(s.id));
        shots = shots.concat(incoming);

        const beansIncoming = Array.isArray(data.beanLibrary) ? data.beanLibrary : [];
        beanLibrary = Array.from(new Set(beanLibrary.concat(beansIncoming))).sort((a,b)=>a.localeCompare(b));
      }else{
        shots = data.shots;
        beanLibrary = Array.isArray(data.beanLibrary) ? data.beanLibrary : [];
      }

      persist();
      renderService();
      alert('Import complete.');
    }catch(e){
      alert('Import failed. File may be corrupted.');
    }
  };
  reader.readAsText(file);
}

/* ---------- Result color helper ---------- */
function resultColor(tag){
  const t = (tag||'').toLowerCase();
  if(t.includes('perfect')) return '#2e7d32';
  if(t.includes('good')) return '#4caf50';
  if(t.includes('too fast')) return '#fb8c00';
  if(t.includes('runny')) return '#fb8c00';
  if(t.includes('too tight')) return '#7b1fa2';
  if(t.includes('bitter')) return '#6d4c41';
  if(t.includes('sour')) return '#1565c0';
  return '#999';
}

/* ---------- Utility ---------- */
function escapeHtml(s){
  return (s??'').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}
</script>
</body>
</html>
