<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Espresso Tracker — Service Mode</title>

<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">

<style>
<style>
:root{
  /* Palette */
  --bg:#F7F1E1;        /* Old lace */
  --panel:#E3D8C1;     /* Bone */
  --text:#66371B;      /* Kobicha */
  --muted:rgba(102,55,27,.65);

  --accent:#B4833D;    /* Dark goldenrod */
  --danger:#c62f2f;

  --line:rgba(102,55,27,.28);
  --hover:rgba(180,131,61,.14);

  /* Shape */
  --radius:18px;
  --radius-lg:26px;
  --radius-sm:14px;

  /* Font (same as your current UI) */
  --sans:-apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,system-ui,Arial;
}

*{ box-sizing:border-box }

html,body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:var(--sans);
}

.wrap{
  max-width:820px;
  margin:0 auto;
  padding:14px;
}

/* Header */
.header{
  position:sticky;
  top:0;
  z-index:10;
  background:rgba(247,241,225,.9);
  backdrop-filter:blur(10px);
  padding:12px 6px 10px;
  border-bottom:1px solid var(--line);
}

.headerRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

/* Cards */
.card{
  background:#fff;
  border-radius:var(--radius-lg);
  border:2px solid var(--line);
  box-shadow:0 10px 18px rgba(102,55,27,.14);
  padding:14px;
}

/* Input tiles */
.grid2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

.tile{
  background:var(--panel);
  border-radius:var(--radius);
  border:2px solid var(--line);
  padding:12px;
  min-height:76px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

.tile .label{
  font-size:12.5px;
  color:var(--muted);
}

.tile .value{
  font-size:22px;
  font-weight:800;
}

/* Chips */
.chips{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

.chip{
  border-radius:999px;
  border:2px solid var(--line);
  padding:8px 12px;
  background:#fff;
  font-size:13.5px;
}

.chip.active{
  background:var(--accent);
  color:#fff;
}

/* Primary button */
.primary{
  width:100%;
  min-height:56px;
  border-radius:999px;
  border:2px solid var(--line);
  background:var(--accent);
  color:#fff;
  font-size:15.5px;
  font-weight:800;
}

/* Bottom nav */
.bottomNav{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:12px;
  width:min(430px,calc(100% - 24px));
  background:#fff;
  border-radius:999px;
  border:2px solid var(--line);
  box-shadow:0 10px 18px rgba(102,55,27,.14);
  padding:8px;
  display:flex;
  gap:6px;
}

.bottomNav button{
  flex:1;
  border:0;
  background:transparent;
  border-radius:999px;
  padding:10px 12px;
  font-weight:700;
  color:var(--text);
}

.bottomNav button.active{
  background:var(--panel);
}
</style>

</style>
</head>

<body>
<div class="wrap">

<!-- SERVICE MODE -->
<section id="service">
  <div class="top">
    <div>
      <div class="title">Espresso Tracker</div>
      <div class="subtitle" id="today"></div>
      <div class="subtitle" id="rangeSubtitle" style="margin-top:6px"></div>
    </div>
  </div>

  <button class="btn btnPrimary" style="width:100%;margin:10px 0 12px" id="btnNewTop">＋ New Shot</button>

  <!-- Backup -->
  <div class="row" style="gap:10px;margin-bottom:12px">
    <button class="btn btnSmall" id="btnExport" type="button">Export</button>
    <button class="btn btnSmall" id="btnImport" type="button">Import</button>
    <input id="importFile" type="file" accept="application/json" class="hidden">
  </div>

  <div class="summaryBar">
    <div class="summaryTabs chips" id="rangeTabs"></div>

    <div class="statPills">
      <div id="stats" class="statPills"></div>
      <div class="sortRow">
        <div class="sortLabel">Sorted by</div>
        <select id="sortSelect" class="sortSelect">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="bean">Bean</option>
        </select>
      </div>
    </div>
  </div>

  <div class="list" id="shotList"></div>
</section>

<!-- NEW SHOT -->
<section id="new" class="hidden">
  <div class="top">
    <div>
      <div class="title" id="formTitle">New Shot</div>
      <div class="kicker" id="formKicker">Fast log</div>
    </div>
    <button class="btn btnGhost" id="btnCancel">Cancel</button>
  </div>

  <label>Date</label>
  <div class="chips" id="dateChips"></div>
  <div class="help">Choose “Yesterday” to re-log past shots.</div>

  <label>Bean</label>
  <div class="row">
    <input id="bean" list="beanList" placeholder="Type bean name…" autocomplete="off">
    <button class="btn btnSmall" id="btnAddBean" type="button">Add</button>
  </div>
  <datalist id="beanList"></datalist>

  <label>Bean Type</label>
  <div class="chips" id="beanTypeChips"></div>
  <input id="customBlend" class="hidden" placeholder="Describe blend (e.g., 70/30 Arabica-Robusta)">

  <label>Roast Profile</label>
  <div class="chips" id="roastChips"></div>

  <label>Brew Method</label>
  <select id="brewMethod">
    <option value="Espresso">Espresso</option>
    <option value="Pour Over">Pour Over</option>
    <option value="Cold Brew">Cold Brew</option>
  </select>

  <div id="fieldsBlock">
    <div class="grid2" style="margin-top:10px">
      <div>
        <label id="lblGrind" style="margin-top:0">Grind</label>
        <input id="grind" placeholder="30">
      </div>
      <div>
        <label id="lblDose" style="margin-top:0">Dose</label>
        <input id="dose" placeholder="18g">
      </div>
      <div>
        <label id="lblYield" style="margin-top:0">Yield</label>
        <input id="yield" placeholder="36g / 30ml">
      </div>
      <div>
        <label id="lblTime" style="margin-top:0">Time</label>
        <input id="time" placeholder="28s">
      </div>
    </div>
  </div>

  <label>Flavor Profile</label>
  <div class="flavorBlock" id="flavorBlock"></div>

  <label>Result</label>
  <div class="chips" id="resultChips"></div>
  <input id="resultCustom" class="hidden" placeholder="Custom result (e.g., Channeling, Under-extracted)">

  <label>Notes</label>
  <textarea id="notes" placeholder="Quick notes… (optional)"></textarea>

  <div class="footerBtns">
    <button class="btn btnPrimary" id="btnSave">Save</button>
    <button class="btn btnDanger hidden" id="btnDelete">Delete</button>
  </div>
</section>

</div>

<script>
/* ---------------- Storage ---------------- */
const STORAGE_SHOTS = 'shots';
const STORAGE_BEANS = 'beanLibrary';

let shots = safeParse(localStorage.getItem(STORAGE_SHOTS), []);
let beanLibrary = safeParse(localStorage.getItem(STORAGE_BEANS), []);

let view = 'service';
let editingId = null;

const BEAN_TYPES = ['Arabica','Robusta','Liberica','Custom Blend'];
const ROAST_PROFILES = ['Light','Light–Med','Medium','Med–Dark','Dark'];

const FLAVOR_KEYS = [
  { key:'acidity', label:'Acidity' },
  { key:'sweetness', label:'Sweetness' },
  { key:'body', label:'Body' },
  { key:'bitterness', label:'Bitterness' }
];
const FLAVOR_LEVELS = ['Low','Med','High'];

const RESULT_TAGS = ['Perfect','Good','Too Fast','Too Runny','Too Tight','Bitter','Sour','Custom'];

const RANGE_TABS = [
  { key:'today', label:'Today' },
  { key:'thisWeek', label:'This Week (Mon–Sun)' },
  { key:'month', label:'Month' }
];

let range = 'today';
let sortMode = 'newest';

/* Date logging */
let selectedDate = todayKey(); // local date

const els = {
  service: document.getElementById('service'),
  new: document.getElementById('new'),
  today: document.getElementById('today'),
  rangeSubtitle: document.getElementById('rangeSubtitle'),
  shotList: document.getElementById('shotList'),
  stats: document.getElementById('stats'),
  rangeTabs: document.getElementById('rangeTabs'),
  sortSelect: document.getElementById('sortSelect'),

  btnNewTop: document.getElementById('btnNewTop'),
  btnCancel: document.getElementById('btnCancel'),
  btnSave: document.getElementById('btnSave'),
  btnDelete: document.getElementById('btnDelete'),
  btnAddBean: document.getElementById('btnAddBean'),

  btnExport: document.getElementById('btnExport'),
  btnImport: document.getElementById('btnImport'),
  importFile: document.getElementById('importFile'),

  dateChips: document.getElementById('dateChips'),

  formTitle: document.getElementById('formTitle'),
  formKicker: document.getElementById('formKicker'),

  bean: document.getElementById('bean'),
  beanList: document.getElementById('beanList'),

  beanTypeChips: document.getElementById('beanTypeChips'),
  customBlend: document.getElementById('customBlend'),

  roastChips: document.getElementById('roastChips'),

  brewMethod: document.getElementById('brewMethod'),

  lblGrind: document.getElementById('lblGrind'),
  lblDose: document.getElementById('lblDose'),
  lblYield: document.getElementById('lblYield'),
  lblTime: document.getElementById('lblTime'),

  grind: document.getElementById('grind'),
  dose: document.getElementById('dose'),
  yield: document.getElementById('yield'),
  time: document.getElementById('time'),

  flavorBlock: document.getElementById('flavorBlock'),

  resultChips: document.getElementById('resultChips'),
  resultCustom: document.getElementById('resultCustom'),

  notes: document.getElementById('notes')
};

let currentBeanType = 'Arabica';
let currentRoast = 'Medium';

let currentFlavor = { acidity:null, sweetness:null, body:null, bitterness:null };
let currentResultTag = null;
let currentResultCustom = '';

init();

/* ---------------- Init ---------------- */
function init(){
  els.today.textContent = 'Today · ' + fmtDate(new Date());

  renderRangeTabs();
  renderDateChips();
  renderBeanTypeChips();
  renderRoastChips();
  renderFlavorChips();
  renderResultChips();

  normalizeBeanLibrary();
  renderBeanDatalist();

  els.btnNewTop.addEventListener('click', openNew);
  els.btnCancel.addEventListener('click', backToService);
  els.btnSave.addEventListener('click', saveShot);
  els.btnDelete.addEventListener('click', deleteCurrentShot);
  els.btnAddBean.addEventListener('click', addBeanFromPrompt);

  els.brewMethod.addEventListener('change', applyMethodLabels);

  els.sortSelect.addEventListener('change', ()=>{
    sortMode = els.sortSelect.value || 'newest';
    renderService();
  });

  // Backup
  els.btnExport.addEventListener('click', exportData);
  els.btnImport.addEventListener('click', ()=> els.importFile.click());
  els.importFile.addEventListener('change', importData);

  applyMethodLabels();
  render();

  // Safe SW register (won't break UI if SW file missing)
  registerSW();
}

/* ---------------- Date (LOCAL TIME) ---------------- */
function todayKey(d){
  d = d || new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return y + '-' + m + '-' + day;
}

function fmtDate(d){
  return todayKey(d);
}

function yesterdayKey(){
  const d = new Date();
  d.setDate(d.getDate() - 1);
  return todayKey(d);
}

function fmtTime(d){
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return hh + ':' + mm;
}

function fmtStamp(iso){
  if(!iso) return '';
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return '';
  return fmtDate(d) + ' · ' + fmtTime(d);
}

/* ---------------- Range helpers ---------------- */
function weekMonSunBounds(now){
  now = now || new Date();
  const day = now.getDay(); // 0=Sun, 1=Mon
  const diffToMon = (day === 0 ? -6 : 1 - day);

  const start = new Date(now);
  start.setDate(now.getDate() + diffToMon);
  start.setHours(0,0,0,0);

  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  end.setHours(23,59,59,999);

  return { start, end };
}

function shortMD(d){
  return d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' });
}

function prettyDayLabel(dateStr){
  const t = todayKey(new Date());
  const y = yesterdayKey();

  if(dateStr === t) return 'Today';
  if(dateStr === y) return 'Yesterday';

  const d = new Date(dateStr + 'T00:00:00');
  if(Number.isNaN(d.getTime())) return dateStr;
  return d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' });
}

function getShotDateISO(s){
  if(s.createdAt) return s.createdAt;
  if(s.date) return s.date + 'T12:00:00.000Z';
  return null;
}

/* ---------------- Utilities ---------------- */
function safeParse(txt, fallback){
  try{ return txt ? JSON.parse(txt) : fallback; } catch(e){ return fallback; }
}

function persist(){
  localStorage.setItem(STORAGE_SHOTS, JSON.stringify(shots));
  localStorage.setItem(STORAGE_BEANS, JSON.stringify(beanLibrary));
}

function escapeHtml(s){
  return (s??'').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

/* ---------------- Beans ---------------- */
function normalizeBeanLibrary(){
  const set = new Set();
  beanLibrary.forEach(b=>{
    const t = (b||'').toString().trim();
    if(t) set.add(t);
  });
  beanLibrary = Array.from(set).sort((a,b)=>a.localeCompare(b));
  persist();
}

function renderBeanDatalist(){
  els.beanList.innerHTML = beanLibrary.map(b=>'<option value="' + escapeHtml(b) + '"></option>').join('');
}

function addBeanToLibrary(name){
  const t = (name||'').toString().trim();
  if(!t) return;
  if(!beanLibrary.includes(t)){
    beanLibrary.push(t);
    normalizeBeanLibrary();
    renderBeanDatalist();
  }
}

function addBeanFromPrompt(){
  const v = prompt('Add bean name:');
  if(!v) return;
  addBeanToLibrary(v);
  els.bean.value = v.trim();
  els.bean.focus();
}

/* ---------------- Date chips ---------------- */
function renderDateChips(){
  const options = [
    { key: todayKey(new Date()), label: 'Today' },
    { key: yesterdayKey(), label: 'Yesterday' }
  ];

  els.dateChips.innerHTML = '';
  options.forEach(opt=>{
    const c = document.createElement('div');
    c.className = 'chip' + (opt.key === selectedDate ? ' active' : '');
    c.textContent = opt.label;
    c.addEventListener('click', ()=>{
      selectedDate = opt.key;
      renderDateChips();
    });
    els.dateChips.appendChild(c);
  });
}

/* ---------------- Range tabs ---------------- */
function renderRangeTabs(){
  els.rangeTabs.innerHTML = '';
  RANGE_TABS.forEach(t=>{
    const c = document.createElement('div');
    c.className = 'chip' + (t.key===range ? ' active':'');
    c.textContent = t.label;
    c.addEventListener('click', ()=>{
      range = t.key;
      renderRangeTabs();
      renderService();
    });
    els.rangeTabs.appendChild(c);
  });
}

/* ---------------- Bean Type / Roast chips ---------------- */
function renderBeanTypeChips(){
  els.beanTypeChips.innerHTML = '';
  BEAN_TYPES.forEach(t=>{
    const d = document.createElement('div');
    d.className = 'chip' + (t===currentBeanType ? ' active' : '');
    d.textContent = t;
    d.addEventListener('click', ()=>{
      currentBeanType = t;
      [...els.beanTypeChips.children].forEach(x=>x.classList.remove('active'));
      d.classList.add('active');
      els.customBlend.classList.toggle('hidden', t!=='Custom Blend');
      if(t!=='Custom Blend') els.customBlend.value = '';
    });
    els.beanTypeChips.appendChild(d);
  });
}

function renderRoastChips(){
  els.roastChips.innerHTML = '';
  ROAST_PROFILES.forEach(r=>{
    const c = document.createElement('div');
    c.className = 'chip' + (r===currentRoast ? ' active' : '');
    c.textContent = r;
    c.addEventListener('click', ()=>{
      currentRoast = r;
      [...els.roastChips.children].forEach(x=>x.classList.remove('active'));
      c.classList.add('active');
    });
    els.roastChips.appendChild(c);
  });
}

function applyBeanTypeToUI(beanType){
  currentBeanType = beanType || 'Arabica';
  [...els.beanTypeChips.children].forEach(ch=>{
    ch.classList.toggle('active', ch.textContent === currentBeanType);
  });
  els.customBlend.classList.toggle('hidden', currentBeanType!=='Custom Blend');
}

function applyRoastToUI(roast){
  currentRoast = roast || 'Medium';
  [...els.roastChips.children].forEach(ch=>{
    ch.classList.toggle('active', ch.textContent === currentRoast);
  });
}

/* ---------------- Flavor chips ---------------- */
function renderFlavorChips(){
  els.flavorBlock.innerHTML = '';
  FLAVOR_KEYS.forEach(row=>{
    const wrap = document.createElement('div');
    wrap.className = 'flavorRow';

    const title = document.createElement('div');
    title.className = 'flavorTitle';
    title.textContent = row.label;
    wrap.appendChild(title);

    const chips = document.createElement('div');
    chips.className = 'chips';

    FLAVOR_LEVELS.forEach(level=>{
      const c = document.createElement('div');
      c.className = 'chip';
      c.textContent = level;
      c.addEventListener('click', ()=>{
        const cur = currentFlavor[row.key];
        if(cur === level){
          currentFlavor[row.key] = null;
          c.classList.remove('active');
        }else{
          currentFlavor[row.key] = level;
          [...chips.children].forEach(x=>x.classList.remove('active'));
          c.classList.add('active');
        }
      });
      chips.appendChild(c);
    });

    wrap.appendChild(chips);
    els.flavorBlock.appendChild(wrap);
  });
}

function applyFlavorToUI(flavorProfile){
  currentFlavor = {
    acidity: flavorProfile?.acidity ?? null,
    sweetness: flavorProfile?.sweetness ?? null,
    body: flavorProfile?.body ?? null,
    bitterness: flavorProfile?.bitterness ?? null
  };

  const rows = els.flavorBlock.querySelectorAll('.flavorRow');
  rows.forEach((rowEl, idx)=>{
    const key = FLAVOR_KEYS[idx].key;
    const chips = rowEl.querySelectorAll('.chip');
    chips.forEach(ch=>{
      ch.classList.toggle('active', ch.textContent === currentFlavor[key]);
    });
  });
}

/* ---------------- Result chips ---------------- */
function renderResultChips(){
  els.resultChips.innerHTML = '';
  RESULT_TAGS.forEach(tag=>{
    const c = document.createElement('div');
    c.className = 'chip';
    c.textContent = tag;
    c.addEventListener('click', ()=>{
      const was = (currentResultTag === tag);
      currentResultTag = was ? null : tag;

      [...els.resultChips.children].forEach(x=>x.classList.remove('active'));
      if(!was) c.classList.add('active');

      els.resultCustom.classList.toggle('hidden', currentResultTag !== 'Custom');
      if(currentResultTag !== 'Custom'){
        els.resultCustom.value = '';
        currentResultCustom = '';
      }
    });
    els.resultChips.appendChild(c);
  });
}

function applyResultToUI(result){
  currentResultTag = result?.tag ?? null;
  currentResultCustom = result?.custom ?? '';

  [...els.resultChips.children].forEach(ch=>{
    ch.classList.toggle('active', ch.textContent === currentResultTag);
  });

  els.resultCustom.classList.toggle('hidden', currentResultTag !== 'Custom');
  els.resultCustom.value = (currentResultTag === 'Custom') ? currentResultCustom : '';
}

/* ---------------- Method labels ---------------- */
function applyMethodLabels(){
  const m = els.brewMethod.value;

  els.lblGrind.textContent = 'Grind';
  els.grind.placeholder = '30';
  els.grind.parentElement.classList.remove('hidden');

  if(m === 'Espresso'){
    els.grind.parentElement.classList.remove('hidden');
    els.lblDose.textContent = 'Dose';
    els.dose.placeholder = '18g';
    els.lblYield.textContent = 'Yield';
    els.yield.placeholder = '36g / 30ml';
    els.lblTime.textContent = 'Time';
    els.time.placeholder = '28s';
  } else if(m === 'Pour Over'){
    els.grind.parentElement.classList.add('hidden');
    els.lblDose.textContent = 'Dose';
    els.dose.placeholder = '18g';
    els.lblYield.textContent = 'Water';
    els.yield.placeholder = '280g';
    els.lblTime.textContent = 'Time';
    els.time.placeholder = '3:00';
  } else if(m === 'Cold Brew'){
    els.grind.parentElement.classList.add('hidden');
    els.lblDose.textContent = 'Coffee';
    els.dose.placeholder = '60g';
    els.lblYield.textContent = 'Water';
    els.yield.placeholder = '900g';
    els.lblTime.textContent = 'Brew Time';
    els.time.placeholder = '12h';
  }
}

/* ---------------- Render ---------------- */
function render(){
  els.service.classList.toggle('hidden', view!=='service');
  els.new.classList.toggle('hidden', view!=='new');
  if(view==='service') renderService();
}

function withinRange(shot){
  const iso = getShotDateISO(shot);
  if(!iso) return false;
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return false;

  const now = new Date();
  const today = todayKey(now);

  if(range === 'today'){
    const date = (shot.createdAt ? shot.createdAt.slice(0,10) : shot.date);
    return date === today;
  }

  if(range === 'thisWeek'){
    const bounds = weekMonSunBounds(now);
    return d >= bounds.start && d <= bounds.end;
  }

  if(range === 'month'){
    const y = now.getFullYear();
    const m = now.getMonth();
    const start = new Date(y, m, 1, 0,0,0,0);
    const end = new Date(y, m + 1, 0, 23,59,59,999);
    return d >= start && d <= end;
  }

  return false;
}

function computeStats(arr){
  const total = arr.length;
  const beans = new Set(arr.map(s=> (s.bean||'').trim()).filter(Boolean));
  return { total, uniqueBeans: beans.size };
}

function renderStats(arr){
  const st = computeStats(arr);
  els.stats.innerHTML =
    '<div class="pill">' + st.total + ' shots</div>' +
    '<div class="pill">' + st.uniqueBeans + ' beans</div>';
}

function groupByDay(arr){
  const map = new Map();
  arr.forEach(s=>{
    const date = (s.createdAt ? s.createdAt.slice(0,10) : (s.date||''));
    if(!date) return;
    if(!map.has(date)) map.set(date, []);
    map.get(date).push(s);
  });
  return Array.from(map.entries()).sort((a,b)=> b[0].localeCompare(a[0]));
}

function sortShots(arr){
  const copy = [...arr];

  if(sortMode === 'bean'){
    copy.sort((a,b)=>{
      const A = (a.bean||'').toString().trim().toLowerCase();
      const B = (b.bean||'').toString().trim().toLowerCase();
      if(A < B) return -1;
      if(A > B) return 1;
      return (new Date(getShotDateISO(b)||0).getTime()) - (new Date(getShotDateISO(a)||0).getTime());
    });
    return copy;
  }

  if(sortMode === 'oldest'){
    copy.sort((a,b)=> (new Date(getShotDateISO(a)||0).getTime()) - (new Date(getShotDateISO(b)||0).getTime()));
    return copy;
  }

  copy.sort((a,b)=> (new Date(getShotDateISO(b)||0).getTime()) - (new Date(getShotDateISO(a)||0).getTime()));
  return copy;
}

function formatShotLine(s){
  const m = s.brewMethod || 'Espresso';
  if(m === 'Pour Over') return (s.dose||'') + ' → ' + (s.yield||'') + ' · ' + (s.time||'');
  if(m === 'Cold Brew') return (s.dose||'') + ' → ' + (s.yield||'') + ' · ' + (s.time||'');
  return 'grind ' + (s.grind||'') + ' · ' + (s.dose||'') + ' → ' + (s.yield||'') + ' · ' + (s.time||'');
}

function renderService(){
  els.today.textContent = 'Today · ' + fmtDate(new Date());

  if(range === 'thisWeek'){
    const b = weekMonSunBounds(new Date());
    els.rangeSubtitle.textContent = shortMD(b.start) + ' – ' + shortMD(b.end);
  }else{
    els.rangeSubtitle.textContent = '';
  }

  const list = els.shotList;
  list.innerHTML = '';

  let filtered = shots.filter(withinRange);
  filtered = sortShots(filtered);

  renderStats(filtered);

  if(filtered.length === 0){
    const empty = document.createElement('div');
    empty.className = 'card';
    empty.innerHTML = '<div class="metaMuted">No shots in this range.</div>';
    list.appendChild(empty);
    return;
  }

  const grouped = groupByDay(filtered);

  grouped.forEach(([day, items])=>{
    const h = document.createElement('div');
    h.className = 'dayHeader';
    h.textContent = prettyDayLabel(day) + ' · ' + items.length + ' shot' + (items.length>1?'s':'');
    list.appendChild(h);

    items.forEach(s=>{
      const card = document.createElement('div');
      card.className = 'card';

      const bean = escapeHtml(s.bean || 'Untitled bean');
      const type = escapeHtml(s.beanType || '—');
      const roast = escapeHtml(s.roastProfile || '—');
      const method = escapeHtml(s.brewMethod || 'Espresso');

      const line = formatShotLine(s);
      const stamp = fmtStamp(s.createdAt) || escapeHtml(s.date || day);

      const res = s.result?.tag ? s.result.tag : '';
      const resText = (res === 'Custom') ? (s.result.custom || 'Custom') : res;
      const resDot = resultColor(resText);

      const notePreview = (s.notes || '').trim().slice(0, 90);
      const noteLine = notePreview
        ? '<div class="metaMuted" style="margin-top:10px">“' + escapeHtml(notePreview) + ((s.notes||'').trim().length>90?'…':'') + '”</div>'
        : '';

      card.innerHTML =
        '<div class="beanName">' + bean + '</div>' +
        '<div class="metaMuted">' + type + ' · ' + roast + ' · ' + method + '</div>' +
        '<div class="metaLine">' + escapeHtml(line) + '</div>' +
        '<div class="metaMuted" style="margin-top:10px">' + escapeHtml(stamp) + '</div>' +
        (resText ? ('<div class="badge"><span class="dot" style="background:' + resDot + '"></span>' + escapeHtml(resText) + '</div>') : '') +
        noteLine +
        '<div class="actions">' +
          '<button class="btn btnSmall" data-action="edit" data-id="' + escapeHtml(s.id) + '">Edit</button>' +
          '<button class="btn btnDanger btnSmall" data-action="delete" data-id="' + escapeHtml(s.id) + '">Delete</button>' +
        '</div>';

      card.querySelector('[data-action="edit"]').addEventListener('click', ()=> openEdit(s.id));
      card.querySelector('[data-action="delete"]').addEventListener('click', ()=> quickDelete(s.id));

      list.appendChild(card);
    });
  });
}

/* ---------------- Navigation ---------------- */
function openNew(){
  editingId = null;
  view = 'new';
  els.formTitle.textContent = 'New Shot';
  els.formKicker.textContent = 'Fast log';
  els.btnDelete.classList.add('hidden');

  selectedDate = todayKey(new Date());
  renderDateChips();

  const last = shots.length ? shots[shots.length-1] : null;

  els.bean.value = last?.bean || '';
  addBeanToLibrary(els.bean.value);

  applyBeanTypeToUI(last?.beanType || 'Arabica');
  els.customBlend.value = last?.customBlend || '';

  applyRoastToUI(last?.roastProfile || 'Medium');

  els.brewMethod.value = last?.brewMethod || 'Espresso';
  applyMethodLabels();

  els.grind.value = last?.grind || '';
  els.dose.value = last?.dose || '';
  els.yield.value = last?.yield || '';
  els.time.value = last?.time || '';

  applyFlavorToUI(last?.flavorProfile || {});
  applyResultToUI(last?.result || {});
  els.notes.value = '';

  render();
  els.bean.focus();
}

function openEdit(id){
  const s = shots.find(x=>x.id===id);
  if(!s) return;

  editingId = id;
  view = 'new';
  els.formTitle.textContent = 'Edit Shot';
  els.formKicker.textContent = fmtStamp(s.createdAt) || '';
  els.btnDelete.classList.remove('hidden');

  selectedDate = (s.createdAt ? s.createdAt.slice(0,10) : (s.date || todayKey(new Date())));
  renderDateChips();

  els.bean.value = s.bean || '';
  addBeanToLibrary(els.bean.value);

  applyBeanTypeToUI(s.beanType || 'Arabica');
  els.customBlend.value = s.customBlend || '';

  applyRoastToUI(s.roastProfile || 'Medium');

  els.brewMethod.value = s.brewMethod || 'Espresso';
  applyMethodLabels();

  els.grind.value = s.grind || '';
  els.dose.value = s.dose || '';
  els.yield.value = s.yield || '';
  els.time.value = s.time || '';

  applyFlavorToUI(s.flavorProfile || {});
  applyResultToUI(s.result || {});
  els.notes.value = s.notes || '';

  render();
}

function backToService(){
  view = 'service';
  render();
}

/* ---------------- Save/delete ---------------- */
function saveShot(){
  const bean = (els.bean.value || '').trim();
  if(!bean){
    alert('Please enter a bean name.');
    els.bean.focus();
    return;
  }
  addBeanToLibrary(bean);

  const beanType = currentBeanType || 'Arabica';
  const customBlend = (beanType === 'Custom Blend') ? (els.customBlend.value || '').trim() : '';
  const brewMethod = els.brewMethod.value || 'Espresso';
  const roastProfile = currentRoast || 'Medium';

  const tag = currentResultTag || null;
  const custom = (tag === 'Custom') ? (els.resultCustom.value || '').trim() : '';
  const notes = (els.notes.value || '').trim();

  // Keep Yesterday shots as yesterday (stable)
  const createdAtForNew = selectedDate + 'T12:00:00.000Z';

  const shot = {
    id: editingId || ('s_' + Math.random().toString(36).slice(2,10)),
    createdAt: editingId
      ? (shots.find(x=>x.id===editingId)?.createdAt || new Date().toISOString())
      : createdAtForNew,
    date: selectedDate,
    bean: bean,
    beanType: beanType,
    customBlend: customBlend,
    roastProfile: roastProfile,
    brewMethod: brewMethod,
    grind: (brewMethod==='Espresso') ? (els.grind.value || '').trim() : '',
    dose: (els.dose.value || '').trim(),
    yield: (els.yield.value || '').trim(),
    time: (els.time.value || '').trim(),
    flavorProfile: {
      acidity: currentFlavor.acidity,
      sweetness: currentFlavor.sweetness,
      body: currentFlavor.body,
      bitterness: currentFlavor.bitterness
    },
    result: { tag: tag, custom: custom },
    notes: notes
  };

  try{
    if(editingId) shots = shots.map(x=> x.id===editingId ? shot : x);
    else shots.push(shot);
    persist();
    backToService();
  }catch(e){
    alert('Save failed — storage may be full. Try deleting old shots.');
  }
}

function deleteCurrentShot(){
  if(!editingId) return;
  quickDelete(editingId, true);
}

function quickDelete(id, fromEdit){
  fromEdit = !!fromEdit;
  if(!confirm('Delete this shot?')) return;
  shots = shots.filter(x=>x.id!==id);
  persist();
  if(fromEdit) backToService();
  else renderService();
}

/* ---------------- Result color ---------------- */
function resultColor(tag){
  const t = (tag||'').toLowerCase();
  if(t.includes('perfect')) return '#2e7d32';
  if(t.includes('good')) return '#4caf50';
  if(t.includes('too fast')) return '#fb8c00';
  if(t.includes('runny')) return '#fb8c00';
  if(t.includes('too tight')) return '#7b1fa2';
  if(t.includes('bitter')) return '#6d4c41';
  if(t.includes('sour')) return '#1565c0';
  return '#999';
}

/* ---------------- Backup ---------------- */
function exportData(){
  const payload = { exportedAt: new Date().toISOString(), shots: shots, beanLibrary: beanLibrary };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'espresso-tracker-backup-' + todayKey(new Date()) + '.json';
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
  alert('Backup exported. Save it in Files / iCloud.');
}

function importData(evt){
  const file = evt.target.files && evt.target.files[0];
  evt.target.value = '';
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      if(!data || !Array.isArray(data.shots)){
        alert('Invalid backup file.');
        return;
      }

      const merge = confirm('Import backup:\n\nOK = Merge with existing\nCancel = Replace existing');

      if(merge){
        const existingIds = new Set(shots.map(s=>s.id));
        const incoming = data.shots.filter(s=>s && s.id && !existingIds.has(s.id));
        shots = shots.concat(incoming);

        const beansIncoming = Array.isArray(data.beanLibrary) ? data.beanLibrary : [];
        beanLibrary = Array.from(new Set(beanLibrary.concat(beansIncoming))).sort((a,b)=>a.localeCompare(b));
      }else{
        shots = data.shots;
        beanLibrary = Array.isArray(data.beanLibrary) ? data.beanLibrary : [];
      }

      persist();
      renderService();
      alert('Import complete.');
    }catch(e){
      alert('Import failed. File may be corrupted.');
    }
  };
  reader.readAsText(file);
}

/* ---------------- Service worker (safe) ---------------- */
function registerSW(){
  try{
    if(!('serviceWorker' in navigator)) return;
    navigator.serviceWorker.register('./service-worker.js').then(reg=>{
      // Try to update quietly
      if(reg && reg.update) reg.update();
    }).catch(()=>{ /* ignore */ });
  }catch(e){ /* ignore */ }
}
</script>
</body>
</html>
